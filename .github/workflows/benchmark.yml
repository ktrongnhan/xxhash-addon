name: Benchmarks

on:
  push:
    branches: [master]
    paths-ignore: ['README.md']
  pull_request:
    branches: [master]
    paths-ignore: ['README.md']
  workflow_dispatch:

jobs:
  xxhsum-bench:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            os_label: linux-arm64
            compiler: gcc
          - runner: ubuntu-24.04-arm
            os_label: linux-arm64
            compiler: clang
          - runner: windows-11-arm
            os_label: win-arm64
            compiler: msvc
          - runner: windows-11-arm
            os_label: win-arm64
            compiler: clang-cl

    name: xxhsum ${{ matrix.os_label }} ${{ matrix.compiler }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Clang (Ubuntu)
        if: matrix.compiler == 'clang' && startsWith(matrix.runner, 'ubuntu')
        run: sudo apt-get update && sudo apt-get install -y clang

      - name: Setup MSVC
        if: matrix.compiler == 'msvc' || matrix.compiler == 'clang-cl'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install LLVM (Windows)
        if: matrix.compiler == 'clang-cl'
        shell: pwsh
        run: |
          # Download LLVM ARM64 Windows installer
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.7/LLVM-19.1.7-woa64.exe"
          Invoke-WebRequest -Uri $url -OutFile llvm-installer.exe
          Start-Process -Wait -FilePath .\llvm-installer.exe -ArgumentList "/S","/D=C:\LLVM"
          echo "C:\LLVM\bin" >> $env:GITHUB_PATH

      - name: Build xxhsum (GCC / Clang)
        if: matrix.compiler == 'gcc' || matrix.compiler == 'clang'
        working-directory: xxHash
        run: |
          SRCS="xxhash.c cli/xxhsum.c cli/xsum_os_specific.c cli/xsum_arch.c cli/xsum_output.c cli/xsum_sanity_check.c cli/xsum_bench.c"
          ${{ matrix.compiler }} -O3 -DXXH3_STREAM_USE_STACK=1 $SRCS -o xxhsum
          echo "### Compiler" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          ${{ matrix.compiler }} --version | head -1 >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Build xxhsum (MSVC)
        if: matrix.compiler == 'msvc'
        working-directory: xxHash
        shell: cmd
        run: >
          cl /O2 /DXXH3_STREAM_USE_STACK=1
          xxhash.c cli\xxhsum.c cli\xsum_os_specific.c
          cli\xsum_arch.c cli\xsum_output.c
          cli\xsum_sanity_check.c cli\xsum_bench.c
          /Fe:xxhsum.exe

      - name: Build xxhsum (Clang-CL)
        if: matrix.compiler == 'clang-cl'
        working-directory: xxHash
        shell: cmd
        run: >
          clang-cl /O2 -DXXH3_STREAM_USE_STACK=1
          xxhash.c cli\xxhsum.c cli\xsum_os_specific.c
          cli\xsum_arch.c cli\xsum_output.c
          cli\xsum_sanity_check.c cli\xsum_bench.c
          /Fe:xxhsum.exe

      - name: Run benchmark
        working-directory: xxHash
        shell: bash
        run: |
          echo "### xxhsum -b  (${{ matrix.compiler }} on ${{ matrix.os_label }})" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          ./xxhsum -b -i5 2>&1 | tee -a "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
